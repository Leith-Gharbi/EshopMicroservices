# GitLab CI/CD Pipeline for EshopMicroservices
# Deploys to IBM Cloud IKS
# Variables are configured in GitLab CI/CD Settings

stages:
  - build
  - test
  - push
  - deploy-dev
  - deploy-staging
  - deploy-prod

# Variables are defined in GitLab CI/CD Settings:
# - IBM_CLOUD_API_KEY (masked, protected)
# - IBM_CLOUD_REGION
# - IBM_CLOUD_RESOURCE_GROUP
# - IKS_CLUSTER_NAME
# - ICR_REGISTRY
# - ICR_NAMESPACE
# - HELM_CHART_PATH
# - DOCKER_DRIVER

# Build all Docker images
.build_template: &build_template
  stage: build
  image: docker:24-cli
  services:
    - name: docker:24-dind
      alias: docker
      variables:
        DOCKER_TLS_CERTDIR: ""
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - until docker info >/dev/null 2>&1; do echo "Waiting for Docker..."; sleep 2; done
    - docker info
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix|chore)\//'
    - if: '$CI_COMMIT_BRANCH =~ /^(dev|develop)$/'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG =~ /^v/'

build:catalog-api:
  <<: *build_template
  script:
    - cd src/Services/Catalog/Catalog.API
    - docker build -t catalog-api:$CI_COMMIT_SHORT_SHA -f Dockerfile ../../..
    - docker save catalog-api:$CI_COMMIT_SHORT_SHA -o catalog-api.tar
  artifacts:
    paths:
      - src/Services/Catalog/Catalog.API/catalog-api.tar
    expire_in: 2 hours

build:basket-api:
  <<: *build_template
  script:
    - cd src/Services/Basket/Basket.API
    - docker build -t basket-api:$CI_COMMIT_SHORT_SHA -f Dockerfile ../../..
    - docker save basket-api:$CI_COMMIT_SHORT_SHA -o basket-api.tar
  artifacts:
    paths:
      - src/Services/Basket/Basket.API/basket-api.tar
    expire_in: 2 hours

build:ordering-api:
  <<: *build_template
  script:
    - cd src/Services/Ordering/Ordering.API
    - docker build -t ordering-api:$CI_COMMIT_SHORT_SHA -f Dockerfile ../../..
    - docker save ordering-api:$CI_COMMIT_SHORT_SHA -o ordering-api.tar
  artifacts:
    paths:
      - src/Services/Ordering/Ordering.API/ordering-api.tar
    expire_in: 2 hours

build:discount-grpc:
  <<: *build_template
  script:
    - cd src/Services/Discount/Discount.Grpc
    - docker build -t discount-grpc:$CI_COMMIT_SHORT_SHA -f Dockerfile ../../..
    - docker save discount-grpc:$CI_COMMIT_SHORT_SHA -o discount-grpc.tar
  artifacts:
    paths:
      - src/Services/Discount/Discount.Grpc/discount-grpc.tar
    expire_in: 2 hours

build:yarp-gateway:
  <<: *build_template
  script:
    - cd src/ApiGateways/YarpApiGateway
    - docker build -t yarp-gateway:$CI_COMMIT_SHORT_SHA -f Dockerfile ../..
    - docker save yarp-gateway:$CI_COMMIT_SHORT_SHA -o yarp-gateway.tar
  artifacts:
    paths:
      - src/ApiGateways/YarpApiGateway/yarp-gateway.tar
    expire_in: 2 hours

build:shopping-web:
  <<: *build_template
  script:
    - cd src/WebApps/Shopping.Web
    - docker build -t shopping-web:$CI_COMMIT_SHORT_SHA -f Dockerfile ../..
    - docker save shopping-web:$CI_COMMIT_SHORT_SHA -o shopping-web.tar
  artifacts:
    paths:
      - src/WebApps/Shopping.Web/shopping-web.tar
    expire_in: 2 hours

build:healthdeck-web:
  <<: *build_template
  script:
    - cd src/WebApps/HealthDeck.Web
    - docker build -t healthdeck-web:$CI_COMMIT_SHORT_SHA -f Dockerfile ../..
    - docker save healthdeck-web:$CI_COMMIT_SHORT_SHA -o healthdeck-web.tar
  artifacts:
    paths:
      - src/WebApps/HealthDeck.Web/healthdeck-web.tar
    expire_in: 2 hours

# Run tests
test:unit:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - dotnet restore src/eshop-micoservices.sln
    - dotnet build src/eshop-micoservices.sln --configuration Release --no-restore
    - dotnet test src/eshop-micoservices.sln --configuration Release --no-build --verbosity normal
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix|chore)\//'
    - if: '$CI_COMMIT_BRANCH =~ /^(dev|develop)$/'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG =~ /^v/'

# Push images to IBM Container Registry
.push_template: &push_template
  stage: push
  image: icr.io/continuous-delivery/pipeline/pipeline-base-image:2.17
  services:
    - name: docker:24-dind
      alias: docker
      variables:
        DOCKER_TLS_CERTDIR: ""
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - ibmcloud --version
    - ibmcloud login --apikey $IBM_CLOUD_API_KEY -r $IBM_CLOUD_REGION -g $IBM_CLOUD_RESOURCE_GROUP
    - ibmcloud cr login
    - ibmcloud cr namespace-list | grep -q $ICR_NAMESPACE || ibmcloud cr namespace-add $ICR_NAMESPACE
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix|chore)\//'
    - if: '$CI_COMMIT_BRANCH =~ /^(dev|develop)$/'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG =~ /^v/'

push:catalog-api:
  <<: *push_template
  script:
    - docker load -i src/Services/Catalog/Catalog.API/catalog-api.tar
    - docker tag catalog-api:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/catalog-api:$CI_COMMIT_SHORT_SHA
    - docker tag catalog-api:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/catalog-api:latest
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/catalog-api:$CI_COMMIT_SHORT_SHA
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/catalog-api:latest
  needs:
    - job: build:catalog-api
      artifacts: true
    - job: test:unit
      artifacts: false

push:basket-api:
  <<: *push_template
  script:
    - docker load -i src/Services/Basket/Basket.API/basket-api.tar
    - docker tag basket-api:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/basket-api:$CI_COMMIT_SHORT_SHA
    - docker tag basket-api:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/basket-api:latest
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/basket-api:$CI_COMMIT_SHORT_SHA
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/basket-api:latest
  needs:
    - job: build:basket-api
      artifacts: true
    - job: test:unit
      artifacts: false

push:ordering-api:
  <<: *push_template
  script:
    - docker load -i src/Services/Ordering/Ordering.API/ordering-api.tar
    - docker tag ordering-api:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/ordering-api:$CI_COMMIT_SHORT_SHA
    - docker tag ordering-api:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/ordering-api:latest
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/ordering-api:$CI_COMMIT_SHORT_SHA
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/ordering-api:latest
  needs:
    - job: build:ordering-api
      artifacts: true
    - job: test:unit
      artifacts: false

push:discount-grpc:
  <<: *push_template
  script:
    - docker load -i src/Services/Discount/Discount.Grpc/discount-grpc.tar
    - docker tag discount-grpc:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/discount-grpc:$CI_COMMIT_SHORT_SHA
    - docker tag discount-grpc:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/discount-grpc:latest
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/discount-grpc:$CI_COMMIT_SHORT_SHA
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/discount-grpc:latest
  needs:
    - job: build:discount-grpc
      artifacts: true
    - job: test:unit
      artifacts: false

push:yarp-gateway:
  <<: *push_template
  script:
    - docker load -i src/ApiGateways/YarpApiGateway/yarp-gateway.tar
    - docker tag yarp-gateway:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/yarp-gateway:$CI_COMMIT_SHORT_SHA
    - docker tag yarp-gateway:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/yarp-gateway:latest
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/yarp-gateway:$CI_COMMIT_SHORT_SHA
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/yarp-gateway:latest
  needs:
    - job: build:yarp-gateway
      artifacts: true
    - job: test:unit
      artifacts: false

push:shopping-web:
  <<: *push_template
  script:
    - docker load -i src/WebApps/Shopping.Web/shopping-web.tar
    - docker tag shopping-web:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/shopping-web:$CI_COMMIT_SHORT_SHA
    - docker tag shopping-web:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/shopping-web:latest
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/shopping-web:$CI_COMMIT_SHORT_SHA
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/shopping-web:latest
  needs:
    - job: build:shopping-web
      artifacts: true
    - job: test:unit
      artifacts: false

push:healthdeck-web:
  <<: *push_template
  script:
    - docker load -i src/WebApps/HealthDeck.Web/healthdeck-web.tar
    - docker tag healthdeck-web:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/healthdeck-web:$CI_COMMIT_SHORT_SHA
    - docker tag healthdeck-web:$CI_COMMIT_SHORT_SHA $ICR_REGISTRY/$ICR_NAMESPACE/healthdeck-web:latest
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/healthdeck-web:$CI_COMMIT_SHORT_SHA
    - docker push $ICR_REGISTRY/$ICR_NAMESPACE/healthdeck-web:latest
  needs:
    - job: build:healthdeck-web
      artifacts: true
    - job: test:unit
      artifacts: false

# Deploy template with Helm 3 installation
.deploy_template: &deploy_template
  image: icr.io/continuous-delivery/pipeline/pipeline-base-image:2.17
  before_script:
    - ibmcloud login --apikey $IBM_CLOUD_API_KEY -r $IBM_CLOUD_REGION -g $IBM_CLOUD_RESOURCE_GROUP
    - ibmcloud ks cluster config --cluster $IKS_CLUSTER_NAME
    # Install Helm 3 (the base image has Helm 2)
    - curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - helm version
    - kubectl version --client

# Deploy to Development environment (eshop-dev namespace)
# Triggered by: feat/*, fix/*, chore/* branches
deploy:dev:
  <<: *deploy_template
  stage: deploy-dev
  needs:
    - job: push:catalog-api
      artifacts: false
    - job: push:basket-api
      artifacts: false
    - job: push:ordering-api
      artifacts: false
    - job: push:discount-grpc
      artifacts: false
    - job: push:yarp-gateway
      artifacts: false
    - job: push:shopping-web
      artifacts: false
    - job: push:healthdeck-web
      artifacts: false
  script:
    # Create ImagePullSecret for IBM Container Registry
    - kubectl create namespace eshop-dev --dry-run=client -o yaml | kubectl apply -f -
    - kubectl create secret docker-registry icr-secret --docker-server=$ICR_REGISTRY --docker-username=iamapikey --docker-password=$IBM_CLOUD_API_KEY --namespace=eshop-dev --dry-run=client -o yaml | kubectl apply -f -
    - helm upgrade --install eshop-dev $HELM_CHART_PATH --namespace eshop-dev --create-namespace --values $HELM_CHART_PATH/values-dev.yaml --set global.imageTag=$CI_COMMIT_SHORT_SHA --set global.imageRegistry=$ICR_REGISTRY/$ICR_NAMESPACE --set global.imagePullSecrets[0].name=icr-secret --wait --timeout 15m
    - echo "Deployment to eshop-dev complete!"
    - kubectl get pods -n eshop-dev
    - kubectl get svc -n eshop-dev
  environment:
    name: development
    url: http://dev-eshop.yourcompany.com
    on_stop: stop:dev
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix|chore)\//'
      when: always

# Stop development environment
stop:dev:
  <<: *deploy_template
  stage: deploy-dev
  script:
    - helm uninstall eshop-dev --namespace eshop-dev || true
  environment:
    name: development
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix|chore)\//'
      when: manual

# Deploy to Staging environment (eshop-staging namespace)
# Triggered by: dev, develop branches
deploy:staging:
  <<: *deploy_template
  stage: deploy-staging
  needs:
    - job: push:catalog-api
      artifacts: false
    - job: push:basket-api
      artifacts: false
    - job: push:ordering-api
      artifacts: false
    - job: push:discount-grpc
      artifacts: false
    - job: push:yarp-gateway
      artifacts: false
    - job: push:shopping-web
      artifacts: false
    - job: push:healthdeck-web
      artifacts: false
  script:
    # Create ImagePullSecret for IBM Container Registry
    - kubectl create namespace eshop-staging --dry-run=client -o yaml | kubectl apply -f -
    - kubectl create secret docker-registry icr-secret --docker-server=$ICR_REGISTRY --docker-username=iamapikey --docker-password=$IBM_CLOUD_API_KEY --namespace=eshop-staging --dry-run=client -o yaml | kubectl apply -f -
    - helm upgrade --install eshop-staging $HELM_CHART_PATH --namespace eshop-staging --create-namespace --values $HELM_CHART_PATH/values-staging.yaml --set global.imageTag=$CI_COMMIT_SHORT_SHA --set global.imageRegistry=$ICR_REGISTRY/$ICR_NAMESPACE --set global.imagePullSecrets[0].name=icr-secret --wait --timeout 15m
    - echo "Deployment to eshop-staging complete!"
    - kubectl get pods -n eshop-staging
    - kubectl get svc -n eshop-staging
  environment:
    name: staging
    url: http://staging-eshop.yourcompany.com
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(dev|develop)$/'
      when: always

# Deploy to Production environment (eshop-prod namespace)
# Triggered by: main branch or tags v*
deploy:prod:
  <<: *deploy_template
  stage: deploy-prod
  needs:
    - job: push:catalog-api
      artifacts: false
    - job: push:basket-api
      artifacts: false
    - job: push:ordering-api
      artifacts: false
    - job: push:discount-grpc
      artifacts: false
    - job: push:yarp-gateway
      artifacts: false
    - job: push:shopping-web
      artifacts: false
    - job: push:healthdeck-web
      artifacts: false
  script:
    # Create ImagePullSecret for IBM Container Registry
    - kubectl create namespace eshop-prod --dry-run=client -o yaml | kubectl apply -f -
    - kubectl create secret docker-registry icr-secret --docker-server=$ICR_REGISTRY --docker-username=iamapikey --docker-password=$IBM_CLOUD_API_KEY --namespace=eshop-prod --dry-run=client -o yaml | kubectl apply -f -
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        IMAGE_TAG=$CI_COMMIT_TAG
      else
        IMAGE_TAG=$CI_COMMIT_SHORT_SHA
      fi
    - helm upgrade --install eshop-prod $HELM_CHART_PATH --namespace eshop-prod --create-namespace --values $HELM_CHART_PATH/values-prod.yaml --set global.imageTag=$IMAGE_TAG --set global.imageRegistry=$ICR_REGISTRY/$ICR_NAMESPACE --set global.imagePullSecrets[0].name=icr-secret --wait --timeout 15m
    - echo "Deployment to eshop-prod complete!"
    - kubectl get pods -n eshop-prod
    - kubectl get svc -n eshop-prod
    - echo "Production deployment successful! Version - $IMAGE_TAG"
  environment:
    name: production
    url: http://eshop.yourcompany.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - if: '$CI_COMMIT_TAG =~ /^v/'
      when: manual

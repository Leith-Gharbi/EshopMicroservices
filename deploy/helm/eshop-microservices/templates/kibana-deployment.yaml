{{- if .Values.kibana.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "eshop.fullname" . }}-kibana
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "eshop.labels" . | nindent 4 }}
    app.kubernetes.io/component: kibana
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "eshop.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: kibana
  template:
    metadata:
      annotations:
        deploymentTimestamp: {{ .Values.global.deploymentTimestamp | default "0" | quote }}
      labels:
        {{- include "eshop.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: kibana
    spec:
      # Wait for Elasticsearch to be ready before starting Kibana
      initContainers:
      - name: wait-for-elasticsearch
        image: busybox:1.36
        command:
          - sh
          - -c
          - |
            echo "Waiting for Elasticsearch to be ready..."
            RETRIES=0
            MAX_RETRIES=60
            while [ $RETRIES -lt $MAX_RETRIES ]; do
              HEALTH=$(wget -q -O- {{ include "eshop.elasticsearchUrl" . }}/_cluster/health 2>/dev/null || echo "")
              if echo "$HEALTH" | grep -q '"status":"green"\|"status":"yellow"'; then
                echo "Elasticsearch is ready! Status: $(echo $HEALTH | grep -o '"status":"[^"]*"')"
                exit 0
              fi
              RETRIES=$((RETRIES + 1))
              echo "Elasticsearch not ready (attempt $RETRIES/$MAX_RETRIES), waiting 5 seconds..."
              sleep 5
            done
            echo "ERROR: Elasticsearch did not become ready in time"
            exit 1
      containers:
      - name: kibana
        image: {{ .Values.kibana.image }}
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 5601
          protocol: TCP
        env:
        - name: ELASTICSEARCH_HOSTS
          value: {{ include "eshop.elasticsearchUrl" . | quote }}
        resources:
          {{- toYaml .Values.kibana.resources | nindent 10 }}
        # Startup probe - gives Kibana time to fully initialize before liveness/readiness kick in
        # Kibana 8.x takes 60-120 seconds to fully initialize
        startupProbe:
          httpGet:
            path: /api/status
            port: http
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 30
        livenessProbe:
          httpGet:
            path: /api/status
            port: http
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/status
            port: http
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
{{- end }}

{{- if .Values.networkPolicies.enabled }}
---
# Allow Gateway to access all APIs
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "eshop.fullname" . }}-gateway-to-apis
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "eshop.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: yarp-gateway
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          {{- include "eshop.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: 8080
---
# Allow APIs to access their databases
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "eshop.fullname" . }}-apis-to-databases
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "eshop.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "eshop.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: postgresql-catalogdb
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: postgresql-basketdb
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: sqlserver
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 1433
---
# Allow Basket and Ordering APIs to access RabbitMQ
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "eshop.fullname" . }}-apis-to-rabbitmq
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "eshop.labels" . | nindent 4 }}
spec:
  podSelector:
    matchExpressions:
    - key: app.kubernetes.io/component
      operator: In
      values:
      - basket-api
      - ordering-api
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
---
# Allow Basket API to access Redis
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "eshop.fullname" . }}-basket-to-redis
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "eshop.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: basket-api
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: redis
    ports:
    - protocol: TCP
      port: 6379
---
# Allow all services to access Elasticsearch for logging
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "eshop.fullname" . }}-all-to-elasticsearch
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "eshop.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "eshop.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: elasticsearch
    ports:
    - protocol: TCP
      port: 9200
---
# Allow Basket API to access Discount gRPC
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "eshop.fullname" . }}-basket-to-discount
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "eshop.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: basket-api
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: discount-grpc
    ports:
    - protocol: TCP
      port: 8080
{{- end }}
